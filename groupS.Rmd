---
title: "Group S: Nutrition Intake"
author: "Renfang Yang, Yixuan Li, Huan Sun"
date: "2022/4/28"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, message = FALSE, warning = FALSE, echo=FALSE, include=FALSE}
# Load packages.
packages <- c("readr","ggplot2","tidyverse","dplyr","data.table","fs","plotly",
            'glue','maps','ggpubr','ggmap','ggthemes','leaflet','leaflet.extras',
            'tidytext','textdata','DT','RColorBrewer','widgetframe','rgdal')

packages <- lapply(packages, FUN = function(x) {
  if(!require(x, character.only = TRUE)) {
    install.packages(x)
  library(x, character.only = TRUE)
  }
}
)
```



```{r,message = FALSE, warning = FALSE, echo=FALSE, include=FALSE}
# READ FILES
# selected countries
country_list = c('CHN','DEU','IND','JPN','PRK','PAK','PSE','SDN','SYR','USA')

# read the file with country code, country name, and life expectancy
life_df <- read_csv('data/life_exp.csv',show_col_types = FALSE) %>%
  mutate(year = as.numeric(year))

# read the file with food intake
food_df <- read_csv('data/Country-level Nutritions.csv',show_col_types = FALSE)%>%
  filter(varnum <15)%>%
  rename(intake=median)

# read the file with food code, and food name
food_code <- read_csv('data/food_code.csv',show_col_types = FALSE) 

# read the file with food code, and food name
country_code <- read_csv('data/country_code.csv',show_col_types = FALSE) 

# left join the two files above
food_life <- food_df %>%
  left_join(x=food_df, y=life_df, by = c('iso3'='Code','year'='year'))  %>%
  left_join(.,y=food_code, by = c('varnum'='varnum'))
```

# 1. Nutrition Intake Overview
### 1.1 Worldwide Discussion
```{r}
#wordcloud

```


### 1.2 Top Food Worldwide (by average daily intake)
```{r, message = FALSE, warning = FALSE,echo=FALSE}
top_food_box <- food_life %>%
  filter(year==2018,age==999,female==999,urban==999,edu==999) %>%
  ggplot(.,aes(x=reorder(Food,intake), y=intake))+
  geom_boxplot( aes(color=Food,group=Food,fill=Food),alpha = 0.7)+
  labs(title="Food Intake Worldwide",
       caption= "Source:Global Dietary Database",
       y="Average Food Daily Intake(g/d)",x='')+
  # theme(legend.position='none')+
  theme_pander()+
  coord_flip()

ggplotly(top_food_box)
```


### 1.3 Top Food Worldwide by Sex
```{r, message = FALSE, warning = FALSE, echo=FALSE}
top_food_sex <- food_life %>%
  filter(year==2018,age==999,female!=999,urban==999,edu==999) %>%
  mutate(sex=if_else(female==1,'female','male'))%>%
  group_by(Food,sex)%>%
  summarise(intake_avg = round(mean(intake),2))%>%
  arrange(desc(intake_avg))

ggplot(top_food_sex,aes(x=reorder(Food,intake_avg), y=intake_avg,fill=sex)) +
  geom_bar(stat="identity",position="dodge", width = 0.5, alpha = 0.7) +
  labs(title="Differences in Food Intake for Female & Male",
       caption= "Source:Global Dietary Database",
       y="Average Food Daily Intake",x='')+
  theme_pander()+
  coord_flip()
```

### 1.4 Food Intake Worldwide by Year
```{r, message = FALSE, warning = FALSE, echo=FALSE}
# Average Food Intake Worldwide by Year
top_year <- food_life %>%
  filter(age==999,female==999,urban==999,edu==999) %>%
  group_by(year,Food)%>%
  summarise(intake_avg = round(mean(intake),2))%>%
  arrange(desc(intake_avg)) 
  
plot1 <- top_year%>%
  ggplot(., aes(x = year, y=intake_avg,group=Food,color=Food)) + 
  geom_line( size=1)+
  geom_point(size=1)+
  labs(x='Year', y='Intake Avg(g/day)', title='Average Food Intake Worldwide')+
  theme_pander()

ggplotly(plot1)
```


# 2. Dietary Struture
```{r}
#Dietary Struture 1990

```

```{r}
#Dietary Struture 2018

```

### 2.1 Dietary Struture Changes in China
```{r}
#Dietary Struture 1990 in rural China

```

```{r}
#Dietary Struture 2018 in urban China

```


```{r}
# Refined Grains & Non-starchy Vegetables by Gender in China

```

### 2.2 Refined Grains
```{r}
# Refined Grains wordcloud

```

#### Refined Grains Intake Over the World

```{r}
# read the refined grains data in 
refined_grains <- read.csv("data/Country-level-estimates/v07_cnty.csv")

refined <- read.csv("data/Country-level-estimates/v07_cnty.csv")%>%
  filter(year==2018,female!=999,age==999,urban==999,edu==999)%>%
  dplyr::select(iso3,female,median)
```


```{r}
# being shown as median.x in the sp file
refined_female<-refined%>%
  filter(female==1)%>%
  dplyr::select(iso3,median)

# being shown as median.y 
refined_male <- refined%>%
  filter(female==0)%>%
  dplyr::select(iso3,median)

# get the world map shape files with rgdal 
library(rgdal)
world_sp = readOGR(dsn= "data/world_map", 
                     layer="TM_WORLD_BORDERS_SIMPL-0.3")

combined <- world_sp@data %>%
  left_join(refined_female,by=c(ISO3="iso3"))%>%
  left_join(refined_male,by=c(ISO3="iso3"))

world_sp@data <- combined
```

Plot the refined grains consumption given sex.
```{r}
plot1 <- leaflet(world_sp,
              leafletOptions(attributionControl = FALSE, minzoom=1.5)) %>% 
  setView(lat=10, lng=0 , zoom=2) %>%
    # Base groups = Background layer
    addTiles(group = "OpenStreetMap") %>%
    addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  # add country borders 
 addPolygons(group='Female Refined Grains Intake',
               stroke = TRUE, smoothFactor = 0.5,
  weight=1, color='#333333', opacity=1, 
 # add first layer:  
  fillColor = ~colorQuantile("Blues", median.x)(median.x), 
  fillOpacity = 1,
 # add label 
  label = ~stringr::str_c(NAME, ' ',
          formatC(median.x, big.mark = ',', format='d')),
  labelOptions = labelOptions(direction = 'auto'))%>%
  # add the second layer: 
  addPolygons(group='Male Refined Grains Intake',
    stroke = TRUE, smoothFactor = 0.5,
  weight=1, color='#333333', opacity=1, 
  fillColor = ~colorQuantile("Reds",median.y)(median.y), fillOpacity = 1,
 # add label 
  label = ~stringr::str_c(NAME, ' ',
          formatC(median.x, big.mark = ',', format='d')),
  labelOptions = labelOptions(direction = 'auto'))%>%
  # add layer control
  addLayersControl( 
    baseGroups = c("OpenStreetMap", "Toner Lite"), #<<
    overlayGroups = c("Female Refined Grains Intake","Male Refined Grains Intake"), #<<
    options = layersControlOptions(collapsed = TRUE) )

#frameWidget(plot1)

widgetframe::frameWidget(plot1, width = "100%")
```
The maps suggests that worldwide wise, there's no obvious difference in refined grains intake upon gender. But the distribution of densely darkened countries suggests that there's may have some insights super-regional wise. 

```{r}
# Refined Grains bar chart by continent

df <- refined_grains%>%
  filter(age==999,female==999,urban==999,edu==999)%>%
  dplyr::select(superregion2,iso3,year,median)%>%
  group_by(superregion2,year)%>%
  mutate(regional_avg=mean(median))%>%
  select(superregion2,year,regional_avg)%>% 
  mutate(superregion2 = recode(superregion2, Asia = "East & Southeast Asia",
                               FSU = "Former Soviet Union",
                               HIC =  "High-Income Countries",
                               LAC = "Latin America & Caribbean",
                               MENA= "Middle East & North Africa",
                               SAARC ="South Asia",
                               SSA = "Sub-Saharan Africa"
                               ))

df%>% 
  ggplot(aes(x = year, y = regional_avg, 
                   color = factor(superregion2,levels=c("East & Southeast Asia",
                                           "Former Soviet Union", 
                                           "High-Income Countries", 
                                           "Latin America & Caribbean",
                                           "Middle East & North Africa",
                                           "South Asia",
                                           "Sub-Saharan Africa")))) + 
  geom_point(size = 2, alpha = 0.5)+
  geom_smooth(se = F, alpha=0.3) +
  scale_color_manual(values = c("#67001f", "#d6604d",
                                  "#fddbc7", "#d1e5f0", "#92c5de",
                                  "#2166ac", "#053061"))+
  guides(color=guide_legend(title=NULL))+
  theme_minimal() + 
  labs(x = "Year", y = "Grams") +
  scale_x_continuous(breaks = seq(1990, 2018, 5), guide = guide_axis(angle = 0))+
  theme(axis.title.y = element_text(vjust = 2),
        legend.direction = "horizontal",
        legend.justification = 0.05,
        legend.position = "top",
        legend.text = element_text(size = 6, color = "gray10"),
        panel.grid.minor.y =element_blank()) + 
  ggtitle("Superregional Refined Grains Average Intake") + 
  labs(caption = "*For all ages, gender, rural/urban, edu background.")

```
_*Takeaway*_:
Throughout the year from 1990 to 2015, the _High Income Countries_ have shown a significantly lower consumption of refined grains compared to other super regional areas. Both South and East&Southeast Asia consumes the highest amount of refined grains. 

### 2.3 Non-starchy Vegetables
```{r}
# Vegetables wordcloud

```

There are two main categories of vegetables: starchy and non-starchy. Starchy types include potatoes, corn and beans, while non-starchy types include broccoli, tomatoes and zucchini,etc. Both types of veggies are rich in fiber and nutrients, but starchy vegetables are known with higher percentage of carbs and calories.

Note the _unit_ for the survey data of *non starchy vegetables* is _grams per day_.

Here I try to calculate the female respondents' average intake of non starchy vegetables in 2018. 

The code book suggests that the value being _999_ means that the query variable of `age`, `edu`, `urban` includes no breakdown.
```{r}
# get the data in 
non_starchy_vegs<-read.csv("data/Country-level-estimates/v02_cnty.csv")
starchy_vegs<-read.csv("data/Country-level-estimates/v04_cnty.csv")

female_nsv_18<- non_starchy_vegs %>%
  # choose the year of 2018 for present 
  filter(year==2018,age==999,edu==999,urban==999,female==1)%>%
  dplyr::select(iso3,median)%>%
  arrange(desc(median))%>%
  rename(non_starchy_vegs_mean=median)

female_sv_18<- starchy_vegs %>%
  filter(year==2018,age==999,edu==999,urban==999,female==1)%>% 
  # can add a filter of gender, with two layers
  dplyr::select(iso3,median)%>%
  arrange(desc(median))%>%
  rename(starchy_vegs_mean=median)

# add selected data from the dataset back to shape-files
combined <- world_sp@data %>%
  left_join(female_nsv_18,by=c(ISO3="iso3"))%>%
  left_join(female_sv_18,by=c(ISO3="iso3"))

world_sp@data <- combined
```

```{r}
plot2 <- leaflet(world_sp,
              leafletOptions(attributionControl = FALSE, minzoom=1.5)) %>% 
  setView(lat=10, lng=0 , zoom=2) %>%
    # Base groups = Background layer
    addTiles(group = "OpenStreetMap") %>%
    addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  # add country borders 
 addPolygons(group='Non-strachy Vegetables',
               stroke = TRUE, smoothFactor = 0.5,
  weight=1, color='#333333', opacity=1, 
 # add first layer:  
  fillColor = ~colorQuantile("Blues", non_starchy_vegs_mean)(non_starchy_vegs_mean), 
  fillOpacity = 1,
 # add label 
  label = ~stringr::str_c(NAME, ' ',
          formatC(non_starchy_vegs_mean, big.mark = ',', format='d')),
  labelOptions = labelOptions(direction = 'auto'))%>%
  # add the second layer: 
  addPolygons(group='Strachy Vegetables',
    stroke = TRUE, smoothFactor = 0.5,
  weight=1, color='#333333', opacity=1, 
  fillColor = ~colorQuantile("Reds",starchy_vegs_mean)(starchy_vegs_mean), fillOpacity = 1,
 # add label 
  label = ~stringr::str_c(NAME, ' ',
          formatC(starchy_vegs_mean, big.mark = ',', format='d')),
  labelOptions = labelOptions(direction = 'auto'))%>%
  # add layer control
  addLayersControl( 
    baseGroups = c("OpenStreetMap", "Toner Lite"), #<<
    overlayGroups = c("Non-strachy Vegetables","Strachy Vegetables"), #<<
    options = layersControlOptions(collapsed = TRUE) )

frameWidget(plot2)
```
_*Takeaway*_:
For starchy vegetables, South America, West Asia and Middle Africa  countries had an overall higher consumption, and North America and Australia have a relatively low consumption compared to that.

Yet for non-starchy vegetables, Asian women have an significantly and obvious higher intake than the rest of the world. Women in Middle Africa also have this pattern of food intake.

```{r}
# Vegetables bar chart by continent
df01 <- non_starchy_vegs%>%
  filter(age==999,female==999,urban==999,edu==999)%>%
  dplyr::select(superregion2,iso3,year,median)%>%
  group_by(superregion2,year)%>%
  mutate(regional_avg=mean(median))%>%
  select(superregion2,year,regional_avg)%>% 
  mutate(superregion2 = recode(superregion2, Asia = "East & Southeast Asia",
                               FSU = "Former Soviet Union",
                               HIC =  "High-Income Countries",
                               LAC = "Latin America & Caribbean",
                               MENA= "Middle East & North Africa",
                               SAARC ="South Asia",
                               SSA = "Sub-Saharan Africa"
                               ))

df01%>% 
  ggplot(aes(x = year, y = regional_avg, 
                   color = factor(superregion2,levels=c("East & Southeast Asia",
                                           "Former Soviet Union", 
                                           "High-Income Countries", 
                                           "Latin America & Caribbean",
                                           "Middle East & North Africa",
                                           "South Asia",
                                           "Sub-Saharan Africa")))) + 
  geom_point(size = 2, alpha = 0.5)+
  geom_smooth(se = F, alpha=0.3) +
  scale_color_manual(values = c("#67001f", "#d6604d",
                                  "#fddbc7", "#d1e5f0", "#92c5de",
                                  "#2166ac", "#053061"))+
  guides(color=guide_legend(title=NULL))+
  theme_minimal() + 
  labs(x = "Year", y = "Grams") +
  scale_x_continuous(breaks = seq(1990, 2018, 5), guide = guide_axis(angle = 0))+
  theme(axis.title.y = element_text(vjust = 2),
        legend.direction = "horizontal",
        legend.justification = 0.05,
        legend.position = "top",
        legend.text = element_text(size = 8, color = "gray10"),
        panel.grid.minor.y =element_blank()) + 
  ggtitle("Superregional Non Starchy Vegetables Average Intake") + 
  labs(caption = "*For all ages, gender, rural/urban, edu background.")

```
_*Takeaway*_:
Latin America & Caribbean countries has the lowest intake of non starchy vegetables, and surprisingly, the high income countries also shows a relatively low non starchy vegetables consumption. 
Russia (Former Soviet Union) has an increasing level of intake that allows it outnumbered other countries by the end of 2018. 

# 3. Nutrition & Health
### 3.1 Food Intake & Life Expetancy
```{r}
# life exp map


```




```{r, message = FALSE, warning = FALSE, echo=FALSE}
# lm reg line chart
food_life2018 <- food_life %>%
    filter(age==999,female==999,urban==999,edu==999,year==2018)

p7<- food_life2018 %>%
  filter(varnum==7)%>%
  ggplot(., aes(x = intake, y=life_exp)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Life expectancy', title="Refined grains")+
  theme_classic()

p2 <- food_life2018 %>%
  filter(varnum==2)%>%
  ggplot(., aes(x = intake, y=life_exp)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Life expectancy', title="Non-starchy vegetables")+
  theme_classic()

p1 <- food_life2018 %>%
  filter(varnum==1)%>%
  ggplot(., aes(x = intake, y=life_exp)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Life expectancy', title="Fruits")+    
  theme_classic()

p3 <- food_life2018 %>%
  filter(varnum==3)%>%
  ggplot(., aes(x = intake, y=life_exp)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Life expectancy', title="Potatoes")+  
  theme_classic()

p8 <- food_life2018 %>%
  filter(varnum==8)%>%
  ggplot(., aes(x = intake, y=life_exp)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Life expectancy', title="Whole grains")+  
  theme_classic()

p9 <- food_life2018 %>%
  filter(varnum==9)%>%
  ggplot(., aes(x = intake, y=life_exp)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Life expectancy', title="Processed meats")+  
  theme_classic()

life_food = ggarrange(p7,p2,p1,p3,p8,p9,ncol = 2, nrow = 3)

annotate_figure(life_food,top = text_grob("Life Expectancy & Food Intake", 
                                color = "#ef8a62", face = "bold", size = 14))
```


### 3.1 Food Intake & Cancer Rate
```{r}
# cancer rate map


```


```{r, message = FALSE, warning = FALSE, echo=FALSE}
cancer7<- food_life2018 %>%
  filter(varnum==7)%>%
  ggplot(., aes(x = intake, y=cancer_rate)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Cancer Rate', title="Refined grains")+
  theme_classic()

cancer2 <- food_life2018 %>%
  filter(varnum==2)%>%
  ggplot(., aes(x = intake, y=cancer_rate)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Cancer Rate', title="Non-starchy vegetables")+
  theme_classic()

cancer1 <- food_life2018 %>%
  filter(varnum==1)%>%
  ggplot(., aes(x = intake, y=cancer_rate)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Cancer Rate', title="Fruits")+    
  theme_classic()

cancer3 <- food_life2018 %>%
  filter(varnum==3)%>%
  ggplot(., aes(x = intake, y=cancer_rate)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Cancer Rate', title="Potatoes")+  
  theme_classic()

cancer8 <- food_life2018 %>%
  filter(varnum==8)%>%
  ggplot(., aes(x = intake, y=cancer_rate)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Cancer Rate', title="Whole grains")+  
  theme_classic()

cancer9 <- food_life2018 %>%
  filter(varnum==9)%>%
  ggplot(., aes(x = intake, y=cancer_rate)) + 
  geom_point(size=1,color='#2166ac')+
  geom_smooth(method='lm', formula= y~x,color='#ef8a62')+
  labs(x='intake', y='Cancer Rate', title="Processed meats")+  
  theme_classic()

cancer_food = ggarrange(cancer7,cancer2,cancer1,cancer3,cancer8,cancer9,
                   ncol = 2, nrow = 3)

annotate_figure(cancer_food,top = text_grob("Cancer Rate & Food Intake", 
                                color = "#ef8a62", face = "bold", size = 14))
```



# Appendix
### basic information of food intake
```{r}
basic_intake <- food_life %>%
  filter(age==999,female==999,urban==999,edu==999) %>%
  rename(continent = superregion2) %>%
  mutate_at(c('intake'), function(x) round(x,2))%>%
  select(continent,year,Country,Food,intake) %>%
  arrange(Country)

datatable(basic_intake,filter = list(position = "top"),rownames = FALSE) 
```

### basic information of life expectancy & cancer rate
```{r}
basic_life <- food_life %>%
  filter(age==999,female==999,urban==999,edu==999) %>%
  rename(continent = superregion2) %>%
  mutate_at(c('cancer_rate','life_exp'), function(x) round(x,2))%>%
  select(continent,year,Country,life_exp,cancer_rate) %>%
  arrange(Country)

datatable(basic_life,filter = list(position = "top"),rownames = FALSE) 
```

